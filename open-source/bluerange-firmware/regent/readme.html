<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regent / ClcModule :: Fruitymesh</title>
    <link rel="canonical" href="https://www.bluerange.io/docs/opensource/bluerange-firmware/regent/readme.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.bluerange.io/docs/opensource">Fruitymesh</a>
    </div>

    <div class="navbar-end">
      <div class="link navbar-item" id="header-github-logo">
        <a class="link navbar-item" href="https://github.com/mwaylabs/fruitymesh" target="_blank"></a>
      </div>
      <div class="navbar-item">
        <input id="search-input" type="text" placeholder="Search docs">
      </div>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="bluerange-firmware" data-version="master">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title">
      <a href="../index.html">bluerange-firmware</a>
    </h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Quick-Start.html">Quick Start</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Usage.html">Usage</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Features.html">Features</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Developers.html">Developers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../Specification.html">Specification</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../Modules.html">Modules</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../AdvertisingModule.html">AdvertisingModule</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../DebugModule.html">DebugModule</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../DfuModule.html">DfuModule</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../EnrollmentModule.html">EnrollmentModule</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../IoModule.html">IoModule</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../MeshAccessModule.html">MeshAccessModule</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../Node.html">Node</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../ScanningModule.html">ScanningModule</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../StatusReporterModule.html">StatusReporterModule</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text">Other Classes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../Logger.html">Logger</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../RecordStorage.html">RecordStorage</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text">Other</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../Class-Structure.html">Class Structure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../Debugging.html">Debugging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../Battery-Consumption.html">Battery Consumption</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../RecordStorage.html">RecordStorage</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../The-FruityMesh-Algorithm.html">The FruityMesh Algorithm</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../The-Algorithm-in-Detail.html">In Detail</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../Simulator.html">Simulator</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../Tutorials.html">Tutorials</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../Implementing-a-Custom-Module.html">Implementing a Custom Module</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../FAQ.html">FAQ</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">bluerange-firmware</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">bluerange-firmware</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="crumbs" role="navigation" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="../index.html">bluerange-firmware</a></li>
    <li class="crumb"><a href="readme.html">Regent / ClcModule</a></li>
  </ul>
</nav>
</div>
<article class="doc">
<h1>Regent / ClcModule</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>CLC (connected lighting controller)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_general"><a class="anchor" href="#_general"></a>General</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The code for regent is part of the ClcModule. Currently, the ClcModule uses the ClcComm for the UART Communication with the regent controller and the ClcAppConnection for communicating with the Tunable White App.
For Specification of the Communication, look at:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="Pflichtenheft Software Connected Lighting Module v1.6-inWork4.pdf" class="bare">Pflichtenheft Software Connected Lighting Module v1.6-inWork4.pdf</a></p>
</li>
<li>
<p><a href="Software Definition Kommunikationsablauf App - Leuchte v1.3.pdf" class="bare">Software Definition Kommunikationsablauf App - Leuchte v1.3.pdf</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Internally, regent uses modbus, and we use a very similar structure to communicate with their controller and send that information to our cloud.</p>
</div>
<div class="sect2">
<h3 id="_featuresets"><a class="anchor" href="#_featuresets"></a>Featuresets</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">prod_clc_mesh_nrf52</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Runs on the clc module</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">prod_clc_sink_nrf51</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Special build necessary for the MeshGateway used by regent that can convert clc messages into json format (Should be made part of general sink)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<h1 id="_setup" class="sect0"><a class="anchor" href="#_setup"></a>Setup</h1>
<div class="paragraph">
<p><span class="image"><img src="_images/img/debugger.png" alt="debugger"></span></p>
</div>
<div class="sect2">
<h3 id="_flashing_and_developing_fruitymesh_on_the_clc"><a class="anchor" href="#_flashing_and_developing_fruitymesh_on_the_clc"></a>Flashing and developing FruityMesh on the CLC</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Do these steps in this order, otherwise, the CLC might get destroyed. Only plug in lamp power in the end!
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Attach the Connector to the plug near the BLE module (as shown in the picture). The "CPU" marking should point to the nearby cpu.</p>
</li>
<li>
<p>Attach the clc to a debugger (Debugger must be switched off or disconnected from USB)</p>
</li>
<li>
<p>Attach the clc to the lamp.</p>
</li>
<li>
<p>Plug in the power of the lamp.</p>
</li>
<li>
<p>Switch on the debugger.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>&#8658; When disconnecting, switch off Debugger first, then power off lamp.</p>
</div>
<div class="paragraph">
<p>You can use Segger RTT to work with a terminal if activated because the UART is occupied and used between the two chips.</p>
</div>
</div>
<div class="sect2">
<h3 id="_flashing_the_regent_controller"><a class="anchor" href="#_flashing_the_regent_controller"></a>Flashing the Regent Controller</h3>
<div class="ulist">
<ul>
<li>
<p>Attach the debug connector to the other plug in the corner of the board</p>
</li>
<li>
<p>Chipset is STM32F091CC (no optional bytes), SWD (speed 1000)</p>
</li>
<li>
<p>Use JFlashLite 5.10u (Newer versions do not work with a nordic branded segger debugger)</p>
</li>
<li>
<p>Flash the new binary</p>
</li>
<li>
<p>You can also erase the board first, but the clcloader.hex has to be flashed first and then the new firmware</p>
</li>
<li>
<p>You must reset the board manually (pressing the reset button on the debugger might work)</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Firmware updates can be <strong>.img</strong>, <strong>.bin</strong>, <strong>.hex</strong>. When flashing the CLC, the .hex has to be used. The one packaged in component updates is the .img version. The .bin version is only used when updating the lamp with the batch files from regent.
</td>
</tr>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_debugging"><a class="anchor" href="#_debugging"></a>Debugging</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_testing_the_firmware_update"><a class="anchor" href="#_testing_the_firmware_update"></a>Testing the Firmware Update</h3>
<div class="paragraph">
<p>To test the firmware update, FruityDeploy can be used to flash the update binary on the node directly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">//FruityDeploy flashing: dfuparams &lt;image start is 0 for binary files&gt; &lt;image size is size of .img in bytes&gt; &lt;free space page can be seen when fruitymesh boots up&gt;
--args dev_clc_mesh_nrf52 --dfuimage clm-01.12.XX-4b344bbf-rel.img --dfuparams 0 61440 65

//To test the update request
clc updatereq 15

//To start the update for testing
//params: &lt;moduleId&gt;, &lt;freeSpaceAddress = PAGE_SIZE*freeSpacePageIndex&gt;, &lt;size of .img&gt;
clc update 15 266240 61440</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_component_updates"><a class="anchor" href="#_component_updates"></a>Component Updates</h2>
<div class="sectionbody">

</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>Build with Antora</p>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script>antoraLunr.init("../../_/../search_index.json")</script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>

  </body>
</html>
